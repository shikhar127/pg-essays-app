#!/usr/bin/env node

/**
 * Generate a TypeScript file that maps essay IDs to their content requires
 * This allows dynamic loading of essays at runtime while maintaining React Native's
 * requirement for static require() calls
 */

const fs = require('fs');
const path = require('path');

const indexPath = path.join(__dirname, '../assets/essays/index.json');
const outputPath = path.join(__dirname, '../lib/essayContentMap.ts');

// Read the essay index
const index = JSON.parse(fs.readFileSync(indexPath, 'utf8'));

// Generate the TypeScript file
let output = `// Auto-generated file - DO NOT EDIT
// Generated by scripts/generate-essay-map.js
// Run 'node scripts/generate-essay-map.js' to regenerate

import { Asset } from 'expo-asset';

/**
 * Map of essay IDs to their asset module numbers
 * This allows dynamic loading while keeping React Native's static require() happy
 */
const essayAssetMap: Record<string, any> = {
`;

// Add each essay to the map
for (const essay of index) {
  const id = essay.id;
  // Store the require reference for each essay
  output += `  '${id}': require('../assets/essays/content/${id}.md'),\n`;
}

output += `};

/**
 * Map of essay IDs to their content loaders
 */
export const essayContentMap: Record<string, () => Promise<string>> = {};

// Initialize the content map with async loaders
for (const id of Object.keys(essayAssetMap)) {
  essayContentMap[id] = async () => {
    const asset = Asset.fromModule(essayAssetMap[id]);
    await asset.downloadAsync();

    if (!asset.localUri) {
      throw new Error(\`Failed to download essay: \${id}\`);
    }

    const response = await fetch(asset.localUri);
    const content = await response.text();
    return content;
  };
}

/**
 * Get the list of all available essay IDs
 */
export function getAvailableEssayIds(): string[] {
  return Object.keys(essayContentMap);
}
`;

// Write the output file
fs.writeFileSync(outputPath, output, 'utf8');

console.log(`âœ… Generated essay content map with ${index.length} essays`);
console.log(`   Output: ${outputPath}`);
